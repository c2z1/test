<!DOCTYPE html>
<html>
<head>  
	<meta charset="UTF-8">
    <title>DMI-Forecast</title>
	<style type="text/css">
		.Button { 
			background-color:#aaa; 
			color:#fff; 
			width:78px; 
			height:30px; 
			border:2px solid #ddd; 
			border-radius:10px; 
			font: 18px Georgia, serif; 
			padding-bottom: 5px
			}
		.arrowbtn {
			font-weight: bolder
			}
		.sliderpart {
			height: 30px;
			display: block;
		  	position: relative;
		  	float: left;
		  	background-color: #aaa;
			}
		#datelabel {
			display: inline-block;
			text-align:center; 
			padding-top: 3px;
			vertical-align:top; 
			color: #555; 
			font: 16px Georgia, serif; 
			width: 210px; 
			height: 23px; 
			border:2px solid #ddd; 
			border-radius:10px;
			}
		#imageDiv {
			display: block; 
			width:640px; 
			height:400px
			}
		#navslider {
			display: block; 
			width:640px; 
			height:40px;
			
			}
		#navbutton {
			display: block; 
			width:640px; 
			height:40px
	}	</style>
	<script>
		Date.prototype.addHours = function(h) {
			var ret = new Date()
			ret.setTime(this.getTime() + (h*60*60*1000)); 
			return ret;   
		}
		Wochentag = new Array("Sonntag", "Montag", "Dienstag", "Mittwoch",
	                      "Donnerstag", "Freitag", "Samstag");
						  
		var actualImageNo = 0;
		
		var lastRefresh;
		
		var FirstImgDelay = 6;
		var ImageCount = 49;
		var SliderPartWidth = 13;
		var lastSliderPos = -1;
		
		var SliderPartName = "sliderpart";
		
		function init() {
			initSlider();
			var now = new Date()
			var hours = now.getHours();
			if (hours < 2) {
				hours = hours + 12;
			} else 
			if (hours >= 2 && hours < 8) {
				hours = hours + 6;
			} else 
			if (hours >= 14 && hours < 20) {
				hours = hours - 6;
			} else 
			if (hours >= 20) {
				hours = hours - 12;
			}
			initLastRefreshAndDisplay(now.addHours(-hours-6));
			
		}
	
		function initLastRefreshAndDisplay(date) {
			var nextVal = date.addHours(6)
			img = new Image()
			img.onload = function() {
				setLastRefresh(nextVal)
				display()
			}
			img.onerror = function() {
				initLastRefreshAndDisplay(date.addHours(-6))
			}
			img.src = imageLink("Wind", nextVal, getDate(nextVal, actualImageNo))
		}
		
		function initSlider() {
			for (var i = 0; i < ImageCount; i++) {
				var div = document.createElement("div");
				div.className = SliderPartName;
				div.style.width = SliderPartWidth + "px";
				div.id = "" + i
				div.onmouseover = function() {
					var nr = parseInt(this.id);
					setActImage(nr);
				}
				div.ontouchmove = function(e) {
					var imgNo = e.touches[0].screenX / SliderPartWidth
					setActImage(imgNo.toFixed() - 1)
					e.stopPropagation()
					e.preventDefault()
				}
				document.getElementById('navslider').appendChild(div);
			}
		}
		function displaySliderPos(imgNo) {
			if (lastSliderPos >= 0) {
				getSliderPart(lastSliderPos).style.backgroundColor="#aaa"
			}
			getSliderPart(imgNo).style.backgroundColor="#555"
			lastSliderPos = imgNo;
		}
		
		function getSliderPart(no) {
			return document.getElementById("" + no)
		}
		
		function setActImage(nr) {
			if (nr != actualImageNo) {
	//			print('image ' + nr)
				actualImageNo = nr
				display();
			}
		}
		
		function zweistellig(zahl) {
			if (zahl > 9) return "" + zahl 
			else return "0" + zahl
		}
		
		function dateUrlStr(dateParam) {
			return dateParam.getFullYear() + zweistellig(dateParam.getMonth()+1) 
					+ zweistellig(dateParam.getDate()) + "_" + zweistellig(dateParam.getHours()) + "00"
		}
		
		function imageLink(type, refreshDate, imgDate) {
			return "http://www.dmi.dk/fileadmin/SeaForecast/vestlige_osterso/" + type 
					+ "." + dateUrlStr(refreshDate) + "." + dateUrlStr(imgDate) + ".png"
		}
		
		function getDate(refreshDate, imgNo) {
			return refreshDate.addHours(FirstImgDelay + imgNo)
		}
		
		function nextImage(count) {
			setActImage(actualImageNo + count)
		}
		
		function dateDisplStr(date) {
			return date.getDate() + "." + (date.getMonth()+1) + "." + (date.getFullYear()) + " - " 
					+ date.getHours() + ":00"
		}
		
		function display() {
			displaySliderPos(actualImageNo)
			var imgDate = getDate(lastRefresh, actualImageNo)
			document.getElementById("Wind").src = imageLink("Wind", lastRefresh, imgDate)
			document.getElementById("WindDirection").src = imageLink("WindDirection", lastRefresh, imgDate)
			var displayDate = imgDate.addHours(2)
			document.getElementById("datelabel").innerHTML = Wochentag[displayDate.getDay()] + ", "
					+ dateDisplStr(displayDate) + "   "
		}
		
		function preloadImage(imgNo) {
			var tmpDate = getDate(lastRefresh, i)
			new Image().src = imageLink("Wind", lastRefresh, tmpDate)
			new Image().src = imageLink("WindDirection", lastRefresh, tmpDate)
		}
		
		function loadAllImages() {
			for (var i = 1; i <= ImageCount; i++) {
				preload(i)
			}
		}
		
		function getFirstImgDate() {
			return lastImage.addHours(-ImageCount)
		}
		
		function setLastRefresh(val) {
			lastRefresh = val
			document.getElementById("refreshDateBtn").value = lastRefresh.getHours() + ":00"
		}
		
		function testRefresh() {
 			var newRefresh = lastRefresh.addHours(6)
			var img = new Image()
			img.onload = function() {
				setLastRefresh(newRefresh)
				display()
			}
			img.src = imageLink("Wind", newRefresh, getDate(newRefresh, actualImageNo))
		}
		
		function print(str) {
			document.getElementById("print").innerHTML = document.getElementById("print").innerHTML + "<br>" + str
		}
	</script>
</head>
<body class="fullpage">
	<div id="imageDiv">
		<div style="position: absolute; z-index:1"><img id="Wind" class="overlayImage"></div> 
		<div style="position: relative; z-index:2"><img id="WindDirection" class="overlayImage"></div> 
	</div>
	<div id=navslider></div>
	<div id=navbuttons>
		<input type="submit" class="arrowbtn Button" value="<<" onclick="nextImage(-5)"/>
		<input type="submit" class="arrowbtn Button" value="<" onclick="nextImage(-1)"/>
		<input type="submit" class="arrowbtn Button" value=">" onclick="nextImage(1)"/>
		<input type="submit" class="arrowbtn Button" value=">>" onclick="nextImage(5)"/>
		<label>&nbsp;</label>
		<label id="datelabel" style =></label>
		<label>&nbsp;</label>
		<input type="submit" class="Button" title="Zeit der Vorhersageberechnung" id="refreshDateBtn" 
				onclick="testRefresh()"/>
	</div>
	<br>
	<script>
		init();
	</script>
	<br>
	<label id="print"></label>
	
</body>
</html>
